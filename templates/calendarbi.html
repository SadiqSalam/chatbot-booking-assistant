<!DOCTYPE html>
<html lang="zh-HK" , translate="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¼šè®®å®¤æŸ¥è¯¢åŠ©æ‰‹ - ç²¤è¯­/è‹±è¯­åŒè¯­ç‰ˆ</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="bot-avatar">
          <!-- <i class="fas fa-calendar-check"></i> -->
          <img
            id="logo"
            src="{{ url_for('static', filename='di_better_logo.png') }}"
            alt=""
          />
        </div>
        <div class="header-text">
          <div class="chat-title" id="chatTitle">æœƒè­°å®¤æŸ»è©¢åŠ©æ‰‹</div>
          <div class="chat-subtitle" id="chatSubtitle">ç²µèª/è‹±èªé›™èªæ”¯æŒ</div>
        </div>
        <div class="language-indicator" id="langIndicator">
          <i class="fas fa-language"></i>
          <span id="currentLang">æœªæª¢æ¸¬</span>
        </div>
      </div>

      <div class="chat-history" id="chatHistory">
        <div class="message bot">
          <div class="avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-content">
            <div class="message-text">
              æ‚¨å¥½ï¼ æˆ‘æ˜¯æœƒè­°å®¤åŠ©æ‰‹ï¼Œæ”¯æŒç²µèªå’Œè‹±èªæŸ»è©¢
            </div>
            <div class="message-text">è«‹å‘Šè¨´æˆ‘æ‚¨æƒ³æŸ»è©¢çš„æœƒè­°å®¤å’Œæ™‚é–“æ®µã€‚</div>
            <div class="message-text" style="margin-top: 5px; font-size: 15px">
              Hello! I'm the booking assistant, supporting Cantonese and English
              queries.
            </div>
            <div class="message-text" style="font-size: 15px">
              Please tell me the meeting room and time period you want to check.
            </div>
            <div class="message-time" id="currentTime"></div>
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="input-area">
          <textarea
            class="chat-input"
            id="chatInput"
            placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯ï¼ˆç²¤è¯­/è‹±è¯­ï¼‰..."
          ></textarea>
          <button class="send-btn" id="sendBtn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <script>
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const chatHistory = document.getElementById("chatHistory");
      const currentTime = document.getElementById("currentTime");
      const langIndicator = document.getElementById("currentLang");
      const chatTitle = document.getElementById("chatTitle");
      const chatSubtitle = document.getElementById("chatSubtitle");
      let currentLanguage = null;

      function updateCurrentTime() {
        const now = new Date();
        currentTime.textContent =
          now.getHours() + ":" + now.getMinutes().toString().padStart(2, "0");
      }
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);

      function detectLanguage(text) {
        const chineseRegex = /[\u4e00-\u9fa5]|å˜…|å’—|å’©|å“‹|å•²|å–º|åšŸ|å™‰|å˜…|å’|å””/;
        if (chineseRegex.test(text)) {
          currentLanguage = "cantonese";
          langIndicator.textContent = "ç²¤è¯­";
          chatTitle.textContent = "ä¼šè®®å®¤æŸ¥è¯¢åŠ©æ‰‹";
          chatSubtitle.textContent = "ç²¤è¯­/è‹±è¯­åŒè¯­æ”¯æŒ";
          langIndicator.parentElement.style.background =
            "rgba(30, 136, 229, 0.3)";
          return "cantonese";
        } else {
          currentLanguage = "english";
          langIndicator.textContent = "English";
          chatTitle.textContent = "Booking Room Assistant";
          chatSubtitle.textContent = "Supports Cantonese/English";
          langIndicator.parentElement.style.background =
            "rgba(216, 27, 96, 0.3)";
          return "english";
        }
      }

      function showTypingIndicator() {
        const typingIndicator = document.createElement("div");
        typingIndicator.className = "message bot";
        typingIndicator.innerHTML = `
        <div class="avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>`;
        chatHistory.appendChild(typingIndicator);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return typingIndicator;
      }

      function addMessage(text, sender) {
        const now = new Date();
        const timeString =
          now.getHours() + ":" + now.getMinutes().toString().padStart(2, "0");
        const messageEl = document.createElement("div");
        messageEl.className = `message ${sender}`;
        messageEl.innerHTML = `
        <div class="avatar">
          <i class="fas fa-${sender === "bot" ? "robot" : "user"}"></i>
        </div>
        <div class="message-content">
          <div class="message-text">${text}</div>
          <div class="message-time">${timeString}</div>
        </div>`;
        chatHistory.appendChild(messageEl);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      async function sendMessage() {
        const message = chatInput.value.trim();
        if (message) {
          const detectedLanguage = detectLanguage(message);
          sendBtn.disabled = true;
          addMessage(message, "user");
          chatInput.value = "";
          const typingIndicator = showTypingIndicator();
          try {
            const response = await fetch("/ask", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ query: message }),
            });

            const responseText = await response.text();
            typingIndicator.remove();

            if (!response.ok) {
              addMessage(`âŒ éŒ¯èª¤: ${responseText}`, "bot");
              return;
            }

            let parsed;
            try {
              parsed = JSON.parse(responseText);
            } catch {
              addMessage(responseText, "bot");
              return;
            }

            if (Array.isArray(parsed)) {
              parsed.forEach((entry) => displayRoomResponse(entry));
            } else {
              displayRoomResponse(parsed);
            }

            function displayRoomResponse(entry) {
              if (typeof entry === "string") {
                addMessage(entry, "bot");
                return;
              }
              /*const room = entry.room || entry["æˆ¿é–“"];
              const start = entry.start || entry["é–‹å§‹æ™‚é–“"];
              const end = entry.end || entry["çµæŸæ™‚é–“"];
              const available = entry.available ?? entry["æ˜¯å¦å¯ç”¨"];
              const conflicts = entry.conflicts || entry["è¡çª"] || [];
              const suggestion = entry.suggestion || entry["å»ºè­°"]; */

              const room = entry.room;
              const start = entry.start;
              const end = entry.end;
              const available = entry.available;
              const conflicts = entry.conflicts || [];
              const suggestion = entry.suggestion;

              /*let msg = `ğŸ“ ${room}\nğŸ•’ ${start} - ${end}\nğŸŸ¢ Available: ${
                available === true || available === "âœ… å¯ç”¨"
                  ? "âœ… Yes"
                  : "âŒ No"
              }`;  */

              let availabilityText =
                currentLanguage === "cantonese"
                  ? available
                    ? "âœ… å¯ç”¨"
                    : "âŒ ä¸å¯ç”¨"
                  : available
                  ? "âœ… Yes"
                  : "âŒ No";

              let msg = `ğŸ“ ${room}\nğŸ•’ ${start} - ${end}\nğŸŸ¢ Available: ${availabilityText}`;

              /**if (conflicts.length > 0) {
                msg +=
                  `\nğŸ“Œ Conflicts:\n` +
                  conflicts
                    .map((c) => {
                      const title = c.title || c["æ´»å‹•"];
                      const cStart = c.start || c["é–‹å§‹"];
                      const cEnd = c.end || c["çµæŸ"];
                      const r = c.room || c["æˆ¿é–“"];
                      return `â€¢ ${title} @ ${r} (${cStart} - ${cEnd})`;
                    })
                    .join("\n");
              }  */

              if (conflicts.length > 0) {
                msg +=
                  currentLanguage === "cantonese"
                    ? `\nğŸ“Œ æ™‚é–“è¡çªï¼š\n`
                    : `\nğŸ“Œ Conflicts:\n`;

                msg += conflicts
                  .map((c) => {
                    const title = c.title;
                    const cStart = c.start;
                    const cEnd = c.end;
                    const r = c.room;
                    const note = c.note || "";
                    return `â€¢ ${title} @ ${r} (${cStart} - ${cEnd})${
                      note ? ` - ${note}` : ""
                    }`;
                  })
                  .join("\n");
              }

              if (!available && suggestion?.suggested_room) {
                const suggestionText =
                  currentLanguage === "cantonese"
                    ? `\nğŸ” å»ºè­°ï¼šå¯è€ƒæ…®ä½¿ç”¨ **${suggestion.suggested_room}**ï¼Œè©²æˆ¿é–“åœ¨æ­¤æ™‚æ®µå¯ç”¨ã€‚`
                    : `\nğŸ” Suggestion: You can try **${suggestion.suggested_room}** â€“ it's available during this time.`;
                msg += suggestionText;
              }

              addMessage(msg, "bot");
            }
          } catch (error) {
            typingIndicator.remove();
            addMessage(`æŠ±æ­‰ï¼Œè™•ç†æ‚¨çš„è«‹æ±‚æ™‚å‡ºéŒ¯: ${error.message}`, "bot");
          } finally {
            sendBtn.disabled = false;
          }
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      chatInput.addEventListener("input", () => {
        if (chatInput.value.trim().length > 0) {
          detectLanguage(chatInput.value);
        } else {
          currentLanguage = null;
          langIndicator.textContent = "æœªæª¢æ¸¬";
          chatTitle.textContent = "ä¼šè®®å®¤æŸ¥è¯¢åŠ©æ‰‹";
          chatSubtitle.textContent = "ç²¤è¯­/è‹±è¯­åŒè¯­æ”¯æŒ";
          langIndicator.parentElement.style.background =
            "rgba(255,255,255,0.2)";
        }
      });

      chatInput.focus();
    </script>
  </body>
</html>
